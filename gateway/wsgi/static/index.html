<html>
<head><title>SGS</title></head>
<meta http-equiv='Content-type' content='text/html; charset=UTF-8'>
<script src='/static/event_parse.js'></script>
<script src='/static/hint_parse.js'></script>
<script src='/static/strings.js'></script>
<script src='/static/views.js'></script>
<script>
var BEAT_INTERVAL = 2000;
var status_heartbeat = null;
var hint_heartbeat = null;
var events_heartbeat = null;

function post_data(data, url, on_sent) {
    var req = null;
    try {
        if (window.XMLHttpRequest) {
            req = new XMLHttpRequest();
        } else {
            req = new ActiveXObject("Microsoft.XMLHTTP");
        }
    } catch (e) {
        alert('Browser not support AJAX!');
        return;
    }
    req.open('POST', url, true);
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
            on_sent(eval('(' + req.responseText + ')'));
        }
    }
    req.send(data);
}

function post_act(data) {
    data['token'] = token;
    return post_data(JSON.stringify(data), '/act', function(result) {
        if (result['code'] != 200) {
            alert('SEND:' + JSON.stringify(data));
            alert('REASON:' + result['reason']);
        } else {
            clearTimeout(events_heartbeat);
            getEvents();
        }
    });
}

function Game(me, others, center) {
    var players = new Array();

    this.initPosition = function(playerCount, myPosition) {
        /*
         * 6 5 4 3 2
         * 7       1
         *  My Pos-
         */
        var positions = new Array(6, 5, 4, 3, 2, 7, 1, 0);
        others.push(me);
        for (i in positions) {
            var index = (positions[i] + myPosition) % 8;
            if (index != myPosition) {
                players[index] = new Player(others[i]);
            } else {
                players[index] = new Me(me);
            }
        }
    }
    this.player = function(id) {
        return players[id];
    };
    var hintparser = new SGS_HintParser(this, players, new Center(center));
    this.hint = function(result) {
        center.innerHTML = '';
        hintparser.hint(result);
    };
}

var eventlist = new SGS_EventParser();
var game = null;
var token = localStorage.getItem('token');

function joinGame() {
    post_data('', '/ctrl/add', function(result) {
        if (result['code'] == 200) {
            token = result['token'];
            localStorage.setItem('token', token);
            enter();
        } else {
            msgPane.innerHTML = result['reason'];
        }
    });
}

function updateRoomPlayers(count, is_host) {
    document.getElementById('players_count').innerHTML = count;
    document.getElementById('start_button').disabled = (0 == is_host);
}

function enter() {
    joinPane.style.visibility = 'hidden';
    startPane.style.visibility = 'visible';
    getStatus();
}

function exitGame() {
    joinPane.style.visibility = 'visible';
    startPane.style.visibility = 'hidden';
    post_data(token, '/ctrl/exit', function(r) {});
    token = null;
    clearTimeout(status_heartbeat);
    clearTimeout(hint_heartbeat);
    clearTimeout(events_heartbeat);
}

function startGame() {
    post_data(token, '/ctrl/start', function(result) {
        if (result['code'] == 200) {
            started();
        } else {
            msgPane.innerHTML = result['reason'];
        }
    });
}

function getStatus() {
    post_data(token, '/info/status', function(result) {
        if (result['started'] == 0) {
            updateRoomPlayers(result['players'], result['host']);
            status_heartbeat = setTimeout(enter, BEAT_INTERVAL);
        } else {
            started();
        }
    });
}

function getEvents() {
    var request_body = {
        'token': token,
        'previous event id': eventlist.prevId(),
    };
    post_data(JSON.stringify(request_body), '/info/events', function(result) {
        eventlist.append(result, game);
        events_heartbeat = setTimeout(getEvents, BEAT_INTERVAL);
    });
}

function getHint() {
    post_data(token, '/info/hint', function(result) {
        game.hint(result);
        hint_heartbeat = setTimeout(getHint, BEAT_INTERVAL);
    });
}

function started() {
    startPane.style.visibility = 'hidden';
    gamePane.style.visibility = 'visible';
    clearTimeout(status_heartbeat);
    getEvents();
    getHint();
}

function initViews() {
    var views = new Array();

    var row1st = document.createElement('tr');
    for (col = 0; col < 5; ++col) {
        var column = document.createElement('td');
        row1st.appendChild(column);
        views.push(column);
    }
    gamePane.appendChild(row1st);

    var row2nd = document.createElement('tr');
    var cell2 = document.createElement('td');
    row2nd.appendChild(cell2);
    var cellcenter = document.createElement('td');
    cellcenter.setAttribute('colspan', '3');
    row2nd.appendChild(cellcenter);
    var cell6 = document.createElement('td');
    row2nd.appendChild(cell6);
    gamePane.appendChild(row2nd);

    views.push(cell2);
    views.push(cell6);

    var row3rd = document.createElement('tr');
    var cellme = document.createElement('td');
    cellme.setAttribute('colspan', '5');
    row3rd.appendChild(cellme);
    gamePane.appendChild(row3rd);

    game = new Game(cellme, views, cellcenter);
}

var joinPane = null;
var startPane = null;
var gamePane = null;
var msgPane = null;

function init() {
    paras = document.getElementsByTagName('p');
    joinPane = paras[0];
    startPane = paras[1];
    gamePane = document.getElementsByTagName('table')[0];
    msgPane = paras[2];
    startPane.style.visibility = 'hidden';
    gamePane.style.visibility = 'hidden';

    initViews();

    post_data(token, '/info/checktoken', function(result) {
        if (result['in'] == 1) {
            enter();
        }
    });
}
</script>
<body onload='init()'>
<p><button onclick='joinGame()'>Join</button></p>
<p>
<button id='start_button' onclick='startGame()'>Start</button>
<button onclick='exitGame()'>Exit</button>
<span id='players_count'></span> player(s) in the room now.
</p>
<table border=1></table>
<p></p>
